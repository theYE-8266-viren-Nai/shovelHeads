---
import { getEntry } from "astro:content";
import Layout from "../layouts/Layout.astro";
import "../styles/global.css";
import { Button } from "../components/ui/button";

const entry = await getEntry("posts", "shovelheads-band");
if (!entry) throw new Error("Shovelheads band post not found");
const { Content } = await entry.render();

// Custom parsing of markdown content
const rawContent = entry.body;
const lines = rawContent.split("\n");
let currentSection = "";
type Member = { name: string; role: string; description: string };
type DiscographyItem = {
  title: string;
  year: string;
  type: string;
  description: string;
};
type Show = { date: string; venue: string; location: string };
type Connect = { platform: string; handle: string; url: string };
const sections: {
  members: Member[];
  discography: { ep: DiscographyItem[]; singles: DiscographyItem[] };
  shows: Show[];
  connect: Connect[];
} = {
  members: [],
  discography: { ep: [], singles: [] },
  shows: [],
  connect: [],
};

lines.forEach((line) => {
  if (line.startsWith("## Our Story")) currentSection = "story";
  else if (line.startsWith("## Band Members")) currentSection = "members";
  else if (line.startsWith("## Discography")) currentSection = "discography";
  else if (line.startsWith("## Upcoming Shows and Future Projects"))
    currentSection = "shows";
  else if (line.startsWith("## Connect with Shovelheads"))
    currentSection = "connect";
  else if (currentSection) {
    if (currentSection === "members" && line.trim().startsWith("- **")) {
      const match = line.match(/-\s*\*\*(.*?)\*\*\s*\((.*?)\):(.*)/);
      if (match)
        sections.members.push({
          name: match[1],
          role: match[2],
          description: match[3].trim(),
        });
    } else if (
      currentSection === "discography" &&
      line.trim().startsWith("- **")
    ) {
      const match = line.match(
        /-\s*\*\*(.*?)\*\*\s*\((.*?)\)\s*\((.*?)\):(.*)/
      );
      if (match) {
        if (match[3] === "EP")
          sections.discography.ep.push({
            title: match[1],
            year: match[2],
            type: match[3],
            description: match[4].trim(),
          });
        else
          sections.discography.singles.push({
            title: match[1],
            year: match[2],
            type: match[3],
            description: match[4].trim(),
          });
      }
    } else if (currentSection === "shows" && line.trim().startsWith("-")) {
      const match = line.match(/-\s*(.*?)\s–\s*(.*?),\s*(.*)/);
      if (match)
        sections.shows.push({
          date: match[1],
          venue: match[2],
          location: match[3],
        });
    } else if (currentSection === "connect" && line.trim().startsWith("-")) {
      const match = line.match(/-\s*(.*?):\s*\[(.*?)\]\((.*?)\)/);
      if (match)
        sections.connect.push({
          platform: match[1],
          handle: match[2],
          url: match[3],
        });
    }
  }
});
---

<Layout
  title={entry.data.title}
  description={entry.data.description}
  image={entry.data.image}
  entry={entry}
>
  <section class="mb-12">
    <h2 class="text-2xl font-bold text-gray-900 mb-4">Our Story</h2>
    <div class="prose">
      {
        entry.data.image && (
          <img
            src={entry.data.image}
            alt="Band Formation"
            class="float-left mr-6 mb-4 w-1/3 rounded"
          />
        )
      }
      <Content />
    </div>
  </section>

  <section class="mb-12">
    <h2 class="text-2xl font-bold text-gray-900 mb-4">Band Members</h2>
    <ul class="grid grid-cols-1 md:grid-cols-2 gap-6">
      {
        sections.members.map((member, index) => (
          <li class="bg-white p-4 rounded-lg shadow">
            <strong>{member.name}</strong> ({member.role}): {member.description}
          </li>
        ))
      }
    </ul>
  </section>

  <section class="mb-12">
    <h2 class="text-2xl font-bold text-gray-900 mb-4">Discography</h2>
    <div class="space-y-6">
      {
        sections.discography.ep.length > 0 && (
          <div>
            <h3 class="text-xl font-semibold">EP</h3>
            <ul class="list-disc pl-5">
              {sections.discography.ep.map((item, index) => (
                <li>
                  <strong>{item.title}</strong> ({item.year}):{" "}
                  {item.description}
                </li>
              ))}
            </ul>
          </div>
        )
      }
      {
        sections.discography.singles.length > 0 && (
          <div>
            <h3 class="text-xl font-semibold">Singles</h3>
            <ul class="list-disc pl-5">
              {sections.discography.singles.map((item, index) => (
                <li>
                  <strong>{item.title}</strong> ({item.year}):{" "}
                  {item.description}
                </li>
              ))}
            </ul>
          </div>
        )
      }
    </div>
  </section>

  <section class="mb-12">
    <h2 class="text-2xl font-bold text-gray-900 mb-4">
      Upcoming Shows and Future Projects
    </h2>
    <ul class="list-disc pl-5 space-y-2">
      {
        sections.shows.map((show, index) => (
          <li>
            {show.date} – {show.venue}, {show.location}
          </li>
        ))
      }
    </ul>
    <p class="mt-4">
      More upcoming projects to be announced as the band grows with new members.
    </p>
  </section>

  <section>
    <h2 class="text-2xl font-bold text-gray-900 mb-4">Connect with Us</h2>
    <p>Stay tuned for more from Yangon’s grunge torchbearers:</p>
    <ul class="list-disc pl-5 space-y-2">
      {
        sections.connect.map((contact, index) => (
          <li>
            <a href={contact.url} class="text-indigo-600 hover:text-indigo-800">
              {contact.platform}: {contact.handle}
            </a>
          </li>
        ))
      }
    </ul>
  </section>
  <Button client:load variant="default" size="sm">Contact Us</Button>
</Layout>
